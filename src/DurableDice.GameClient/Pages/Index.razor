@implements IDisposable

@page "/"
@page "/{gameId}"

@using Blazored.LocalStorage
@using DurableDice.Common.Abstractions
@using DurableDice.Common.Models.Commands
@using DurableDice.GameClient.Services
@using Microsoft.AspNetCore.SignalR.Client;
@using DurableDice.Common.Models.State;

@if (string.IsNullOrEmpty(_playerName))
{
	<input placeholder="Enter your name" @bind="@_newPlayerName" />
	<button @onclick="JoinAsync">Set name</button>
}
else if (_gameState != null)
{
	<button @onclick="StartAsync">Start</button>

	<div class="players">
		@foreach (var (player, index) in _players)
		{
			var className = $"player player-{index}";
			if (player.Id == _gameState.ActivePlayerId)
			{
				className += " player-active";
			}
			if (player.Id == _gameState.OwnerId)
			{
				className += " player-owner";
			}

			<div class=@className>
				@player.Name (@(_gameState.PlayerFieldCount(player)) | @player.DiceBuffer | @(_gameState.Geometry.GetLargestContinuousFieldBlock(player.Id)))
			</div>
		}
	</div>

	if (_gameState.Fields.Any())
	{
		if (_gameState.ActivePlayerId == _playerId)
		{
			<button @onclick="EndRoundAsync">End round</button>
		}

		<div class="fields">
			@foreach (var field in _gameState.Fields)
			{
				var ownerIndex = _gameState.Players.FindIndex(x => x.Id == field.OwnerId);
				var className = $"hexagon player-{ownerIndex}";

				if (_playerId == field.OwnerId)
				{
					className += " field-owned";
				}

				if (field.Id == _hoveringFieldId)
				{
					className += _fromFieldId == "" ? " field-hover" : " field-target-hover";
				}

				if (field.Id == _fromFieldId)
				{
					className += " field-attack";
				}

				@foreach (var coordinate in field.Coordinates)
				{
					var left = coordinate.X % 2 == 1
					? coordinate.X * 12
					: coordinate.X * 12;
					var top = coordinate.X % 2 == 1
					? 5 + coordinate.Y * 14
					: coordinate.Y * 13;

					<div class=@className style="left: @(left)px; top: @(top)px;" title=@field.DiceCount @onclick=@(() => FieldClickAsync(field)) @onmouseover=@(() => FieldHover(field)) @onmouseout=@(() => FieldLeave())>
						<div class="left"></div>
						<div class="middle"></div>
						<div class="right"></div>
					</div>
				}
			}
		</div>
	}
}

@code
{
	[Inject]
	public NavigationManager navManager { get; set; } = null!;

	[Inject]
	public ISyncLocalStorageService localStorage { get; set; } = null!;

	[Parameter]
	public string? GameId { get; set; }

	private string _playerId { get; set; } = Guid.NewGuid().ToString();
	private string _newPlayerName = "";
	private string _playerName = "";

	private string _hoveringFieldId = "";

	private string _fromFieldId = "";
	private bool _attacking = false;

	private IGameEntity _gameEntity = null!;

	private GameState? _gameState;

	private IEnumerable<(Player player, int index)> _players
		=> _gameState?.Players.Select((player, index) => (player, index)) ?? throw new Exception();

	protected override void OnInitialized()
	{
		if (string.IsNullOrEmpty(GameId))
		{
			GameId = Guid.NewGuid().ToString();
			navManager.NavigateTo($"/{GameId}", false);

			localStorage.SetItem<string>($"playerId-{GameId}", _playerId);
		}
		else
		{
			_playerId = localStorage.GetItem<string>($"playerId-{GameId}");
			_playerName = _playerId;
		}

		var gameEntityService = new GameEntityService(GameId);
		gameEntityService.NewStateReceived += NewState;

		_gameEntity = gameEntityService;
	}

	private void NewState(GameState state)
	{
		_gameState = state;

		if (_attacking)
		{
			_attacking = false;
			_fromFieldId = "";
		}

		StateHasChanged();
	}

	private async Task JoinAsync()
	{
		if (!string.IsNullOrWhiteSpace(_newPlayerName))
		{
			_playerName = _newPlayerName;

			_gameState = new GameState();

			await _gameEntity.AddPlayerAsync(new AddPlayerCommand(_playerId, _playerName));
		}
	}

	private async Task StartAsync() => await _gameEntity.StartMatchAsync();
	private async Task EndRoundAsync() => await _gameEntity.EndRoundAsync(_playerId);

	private async Task FieldClickAsync(Field field)
	{
		if (_attacking || _gameState == null || _gameState.ActivePlayerId != _playerId)
		{
			return;
		}

		if (string.IsNullOrEmpty(_fromFieldId))
		{
			if (field.OwnerId == _playerId && field.DiceCount > 1)
			{
				_fromFieldId = field.Id;
			}
		}
		else if (field.Id == _fromFieldId)
		{
			_fromFieldId = "";
		}
		else if (field.OwnerId != _playerId)
		{
			await _gameEntity.AttackFieldAsync(new AttackMoveCommand(_playerId, _fromFieldId, field.Id));
			_attacking = true;
		}

		StateHasChanged();
	}

	private async Task FieldHover(Field field)
	{
		if (field.OwnerId == _playerId && _gameState.ActivePlayerId == _playerId && field.DiceCount > 1)
		{
			_hoveringFieldId = field.Id;

			StateHasChanged();
		}
		else if (!string.IsNullOrWhiteSpace(_fromFieldId) && field.OwnerId != _playerId && _gameState.Geometry.AreNeighboringFields(_fromFieldId, field.Id))
		{
			_hoveringFieldId = field.Id;

			StateHasChanged();
		}
	}

	private async Task FieldLeave()
	{
		_hoveringFieldId = "";

		StateHasChanged();
	}

	public void Dispose()
	{
		if (_gameEntity is GameEntityService service)
		{
			service.NewStateReceived -= NewState;
		}
	}
}